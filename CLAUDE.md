# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Development

```sh
npm install          # Install dependencies
npm run dev          # Watch-mode build (inline source maps, auto-rebuilds on change)
npm run build        # Production build → main.js
```

There is no lint or test harness configured. The compiled output (`main.js`) is gitignored — it is generated by esbuild and loaded by Obsidian at runtime. After changing source, rebuild with `npm run build` and reload Obsidian to pick up changes.

## Architecture Overview

This is an Obsidian plugin that detects duplicate notes via title/content similarity and presents them in a sidebar review queue with multi-pane comparison.

### Data flow

```
User trigger (context menu on folder, or command palette)
  → FolderSelectModal / PatternSelectModal   (src/modals/)
    → main.ts: startDuplicateReview() or startPatternReview()
      → CacheManager: check validity            (src/cache.ts)
      → scanner: scanForDuplicates()            (src/scanner/index.ts)
        → collectMarkdownFiles()                — filters by folder, ignores
        → findTitleDuplicates()                 — inverted-index + Jaccard
        → buildExclusionMap() / filter()        — YAML frontmatter exclusions
        → [optional] refineWithContent()        — content Jaccard on candidates only
        → groupDuplicates()                     — cluster by normalized title
      → CacheManager: persist results
      → DuplicateReviewView: render sidebar     (src/views/)
```

### Key design decisions worth knowing

- **Inverted-index title scan** (`scanner/index.ts: findTitleDuplicates`): Each file's normalized title words are inserted into a shared index. A new file only scores Jaccard against files that share at least one word — avoids O(N²) pairwise comparison on large vaults.

- **Content refinement is opt-in and narrow**: `refineWithContent()` only reads and scores files that already passed the title threshold. This keeps I/O minimal on 40k-file vaults.

- **Yielding pattern**: Both `findTitleDuplicates` and `refineWithContent` yield to the event loop after every file/candidate (`await new Promise(r => setTimeout(r, 0))`). This keeps the UI responsive during long scans. They also check an `AbortSignal` at each yield point.

- **Cache lives in `data.json` alongside settings**: `CacheManager` uses the key `"duplicateCache"`; settings are loaded via a whitelist (`SETTINGS_KEYS` in `main.ts`). They coexist without collision. Dirty-path tracking (vault file events → `dirtyPaths` Set) provides lightweight cache invalidation scoped to the folder being queried — a root-folder scan is invalidated by any `.md` change, but a subfolder scan only by changes within that subtree.

- **Two-level dismissals**: Groups can be dismissed as a whole (keyed by sorted path array → stringified for Set lookup) or per-file. Both persist in `data.json` via the plugin's settings object.

- **YAML frontmatter exclusions**: A note can declare `duplicate-exclusion: [[Other Note]]` in its frontmatter to suppress pairing with that note. The exclusion is bidirectional — if A excludes B, the pair is filtered regardless of B's frontmatter. Link targets are resolved case-insensitively against the vault.

### File responsibilities

| File | Role |
|---|---|
| `src/main.ts` | Plugin lifecycle, command/event registration, scan orchestration, dismissal management, cache coordination |
| `src/cache.ts` | `CacheManager` — persist/load/validate scan results; dirty-path tracking via vault events |
| `src/settings.ts` | Settings UI tab (sliders, toggles, textareas, buttons for cache/dismissal management) |
| `src/types.ts` | All shared TypeScript interfaces and `DEFAULT_SETTINGS` |
| `src/similarity/title.ts` | `normalizeTitle()` (strip prefixes like `EAD0001`/`250.25`, punctuation, lowercase) and `titleSimilarity()` (Jaccard on word sets) |
| `src/similarity/content.ts` | `contentSimilarity()` — strips YAML frontmatter, truncates to N chars, Jaccard on word sets |
| `src/scanner/index.ts` | Core detection pipeline: file collection, inverted-index title scan, exclusion map, content refinement, grouping, pattern search |
| `src/modals/FolderSelectModal.ts` | `FuzzySuggestModal<TFolder>` for picking a target folder |
| `src/modals/PatternSelectModal.ts` | `FuzzySuggestModal<string>` for picking a common-pattern to search |
| `src/views/DuplicateReviewView.ts` | Sidebar `ItemView` — hierarchical group/file rendering, expand/collapse, compare/dismiss buttons, live progress bar |
| `styles.css` | All plugin UI styles (BEM-style `.duplicate-review-*` classes) |
| `esbuild.config.mjs` | Build config: entry `src/main.ts` → `main.js`, CJS format, externals `obsidian`/`electron`/node builtins |

### Title normalization rules (important for scanner behavior)

`normalizeTitle()` applies in order: strip `.md` extension → remove leading prefixes matching patterns like `EAD0001` or `250.25` (numeric/alphanumeric codes followed by separator) → lowercase → remove non-word/non-space characters → collapse whitespace. This is what drives grouping — files with identical normalized titles land in the same group.
